!function(){function e(e,t,n,i){Object.defineProperty(e,t,{get:n,set:i,enumerable:!0,configurable:!0})}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n={},i={},l=t.parcelRequire23dc;let s;null==l&&((l=function(e){if(e in n)return n[e].exports;if(e in i){var t=i[e];delete i[e];var l={id:e,exports:{}};return n[e]=l,t.call(l.exports,l,l.exports),l.exports}var s=new Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}).register=function(e,t){i[e]=t},t.parcelRequire23dc=l),l.register("iE7OH",(function(t,n){var i,l;e(t.exports,"register",(function(){return i}),(function(e){return i=e})),e(t.exports,"resolve",(function(){return l}),(function(e){return l=e}));var s={};i=function(e){for(var t=Object.keys(e),n=0;n<t.length;n++)s[t[n]]=e[t[n]]},l=function(e){var t=s[e];if(null==t)throw new Error("Could not resolve bundle with id "+e);return t}})),l.register("aNJCr",(function(t,n){var i;e(t.exports,"getBundleURL",(function(){return i}),(function(e){return i=e}));var l={};function s(e){return(""+e).replace(/^((?:https?|file|ftp|(chrome|moz|safari-web)-extension):\/\/.+)\/[^/]+$/,"$1")+"/"}i=function(e){var t=l[e];return t||(t=function(){try{throw new Error}catch(t){var e=(""+t.stack).match(/(https?|file|ftp|(chrome|moz|safari-web)-extension):\/\/[^)\n]+/g);if(e)return s(e[2])}return"/"}(),l[e]=t),t}})),l("iE7OH").register(JSON.parse('{"3ixOo":"index.45b44beb.js","ddabC":"gen_bg.9017f04e.wasm"}'));const r=new Array(32).fill(void 0);function a(e){return r[e]}r.push(void 0,null,!0,!1);let o=r.length;function c(e){const t=a(e);return function(e){e<36||(r[e]=o,o=e)}(e),t}const h=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});h.decode();let u=new Uint8Array;function d(e,t){return h.decode((0===u.byteLength&&(u=new Uint8Array(s.memory.buffer)),u).subarray(e,e+t))}function _(e){o===r.length&&r.push(r.length+1);const t=o;return o=r[t],r[t]=e,t}let g=32;function f(e){if(1==g)throw new Error("out of js stack");return r[--g]=e,g}class p{static __wrap(e){const t=Object.create(p.prototype);return t.ptr=e,t}toJSON(){return{seed:this.seed}}toString(){return JSON.stringify(this)}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();s.__wbg_generator_free(e)}get seed(){return s.generator_seed(this.ptr)>>>0}genChunk(e,t,n,i){try{s.generator_genChunk(this.ptr,e,t,f(n),f(i))}finally{r[g++]=void 0,r[g++]=void 0}}constructor(e){const t=s.generator_new_from_seed(e);return p.__wrap(t)}}function w(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){c(e)},e.wbg.__wbg_buffer_3f3d764d4747d564=function(e){return _(a(e).buffer)},e.wbg.__wbg_newwithbyteoffsetandlength_d9aa266703cb98be=function(e,t,n){return _(new Uint8Array(a(e),t>>>0,n>>>0))},e.wbg.__wbg_set_83db9690f9353e79=function(e,t,n){a(e).set(a(t),n>>>0)},e.wbg.__wbg_length_9e1ae1900cb0fbd5=function(e){return a(e).length},e.wbg.__wbindgen_throw=function(e,t){throw new Error(d(e,t))},e.wbg.__wbindgen_memory=function(){return _(s.memory)},e}function b(e,t){return s=e.exports,y.__wbindgen_wasm_module=t,u=new Uint8Array,s}var m;async function y(e){void 0===e&&(e=new URL(m));const t=w();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return b(n,i)}m=l("aNJCr").getBundleURL("3ixOo")+l("iE7OH").resolve("ddabC");var k=y;const v={Open:0,Normal:1,Bomb:2},x=16,C={Flagged:1,Clicked:2};class M{static fromGenerator(e,t,n){let i=new M(t,n);return e.genChunk(t,n,i.cell_type,i.neighbouring_bombs_count),i}get chunk_x(){return this._chunk_x}get chunk_y(){return this._chunk_y}get top_left(){return[this.chunk_x*x,this.chunk_y*x]}cell_index_at(e,t){return t*x+e}constructor(e,t){this._chunk_x=e,this._chunk_y=t,this.cell_type=new Uint8Array(256),this.neighbouring_bombs_count=new Uint8Array(256),this.cell_state=new Uint8Array(256)}}class O{chunk_key(e,t){return`${e},${t}`}load(e,t){const n=this.chunk_key(e,t);let i=this.loaded_chunks.get(n);if(i)return Promise.resolve(i);let l=this.loading_queue.get(n);if(l)return l;let s=this._load_chunk(e,t).then((e=>(this.loading_queue.has(n)&&this.loading_queue.delete(n),this.loaded_chunks.set(n,e),Promise.resolve(e))));return this.loading_queue.set(n,s),s}async _load_chunk(e,t){return M.fromGenerator(this.generator,e,t)}unload(e,t){let n=this.chunk_key(e,t);this._unload(n)}_unload(e){this.loaded_chunks.delete(e)}worldRectToChunkBounds(e){let{x1:t,x2:n,y1:i,y2:l}=e;return{x1:Math.floor(t/x),y1:Math.floor(i/x),x2:Math.ceil(n/x),y2:Math.ceil(l/x)}}ensureChunksIn(e){for(let t=e.y1;t<e.y2;t+=1)for(let n=e.x1;n<e.x2;n+=1)this.load(n,t)}unloadOutside(e){let t=new Set;for(let n of this.loaded_chunks.keys()){let[i,l]=n.split(","),s=parseInt(i),r=parseInt(l);(s<e.x1||s>=e.x2||r<e.y1||r>=e.y2)&&t.add(n)}for(let e of t)this._unload(e)}hasLoading(){return this.loading_queue.size>0}getChunk(e,t){let n=this.chunk_key(e,t);return this.loaded_chunks.get(n)}getChunkOfBlock(e,t){let n=Math.floor(e/x),i=Math.floor(t/x),l=this.getChunk(n,i);if(!l)return;let s=l.cell_index_at(e-n*x,t-i*x);return[l,s]}constructor(e){this.generator=e,this.loaded_chunks=new Map,this.loading_queue=new Map}}function T(e,t,n,i,l,s){let r=s*n,a=s*i,o=Math.abs(e-t);if(o<r)return t;let c=o*l*s;return c<r&&(c=r),c>a&&(c=a),e+Math.sign(t-e)*c}class E{constructor(){this.targeted_block=[0,0]}}async function S(){let e=document.createElement("canvas"),t=document.getElementsByClassName("loading")[0];t.textContent="Preparing wasm…",await k(),t.textContent="Initializing map…",document.body.appendChild(e);let n=new R(e,(()=>{t.remove()}));function i(){e.width=window.innerWidth*window.devicePixelRatio,e.height=window.innerHeight*window.devicePixelRatio,window.scrollTo(0,0),n.handleResize()}i(),window.addEventListener("resize",i)}"complete"!==document.readyState?document.addEventListener("readystatechange",(()=>{"complete"===document.readyState&&S()})):S();class R{getDefaultScale(){let e=Math.min(window.innerWidth,window.innerHeight),t=15;return window.innerWidth>800&&window.innerHeight>800&&(t=30),e/t*window.devicePixelRatio}handleResize(){}get deltaT(){return(this.current_update_time-this.last_update_time)/1e3}update(){this.current_update_time=Date.now();let e=this.client_player.targeted_block.slice();this.client_player.targeted_block=this.cursor_at_world.map((e=>Math.floor(e))),e[0]==this.client_player.targeted_block[0]&&e[1]==this.client_player.targeted_block[1]||this.animateOpenNearbyCells(...this.client_player.targeted_block),this.center_pos=this.center_pos.map(((e,t)=>T(e,this.cursor_at_world[t]+.5,1,1/0,12,this.deltaT))),this.visible_world_rect=this.getVisibleWorldRectFromCenter(this.center_pos),this.ensureRegion(),!this.chunk_manager.hasLoading()&&this.on_init_complete&&(this.on_init_complete(),this.on_init_complete=null),this.last_nearby_cell_auto_open_time<this.current_update_time-10&&(this.iterOpenNearbyCells(),this.last_nearby_cell_auto_open_time=this.current_update_time),this.draw(),this.last_update_time=this.current_update_time,requestAnimationFrame(this.update)}getVisibleWorldRectFromCenter(e){let t=this.canvas.width,n=this.canvas.height,i=1/this.scale,l=t/2*i,s=n/2*i;return{x1:e[0]-l,x2:e[0]+l,y1:e[1]-s,y2:e[1]+s}}ensureRegion(){let e=this.chunk_manager.worldRectToChunkBounds(this.getVisibleWorldRectFromCenter(this.client_player.targeted_block.map((e=>e+.5)))),t=this.chunk_manager.worldRectToChunkBounds(this.visible_world_rect);Math.min(e.x1,t.x1),Math.max(e.x2,t.x2),Math.min(e.y1,t.y1),Math.max(e.y2,t.y2);this.chunk_manager.ensureChunksIn(e)}worldToScreen(e,t){return[(e-this.center_pos[0])*this.scale+this.canvas.width/2,(t-this.center_pos[1])*this.scale+this.canvas.height/2]}draw(){let e=this.draw_context;e.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e of this.chunk_manager.loaded_chunks.values())this.drawChunk(e);if(this.clicking_block){let[t,n]=this.worldToScreen(...this.clicking_block);e.fillStyle="#000",e.globalAlpha=.3,e.fillRect(t,n,this.scale,this.scale),e.globalAlpha=1}for(let e of this.players)e!=this.client_player&&this.drawPlayer(e);this.drawPlayer(this.client_player),e.fillStyle="#000";let t=Math.max(2*this.gui_scale,2),n=this.worldToScreen(...this.cursor_at_world);e.fillRect(n[0]-t/2,n[1]-t/2,t,t)}drawChunk(e){let t=this.draw_context,n=e.top_left;if(!(n[0]+x<this.visible_world_rect.x1||n[0]>=this.visible_world_rect.x2||n[1]+x<this.visible_world_rect.y1||n[1]>=this.visible_world_rect.y2))for(let i=0;i<x;i+=1)for(let l=0;l<x;l+=1){let s=e.cell_index_at(l,i);if(e.cell_type[s]==v.Open)continue;let[r,a]=this.worldToScreen(n[0]+l,n[1]+i),[o,c]=[this.scale,this.scale];if(e.cell_state[s]&C.Clicked||e.cell_type[s]==v.Open)if(e.cell_type[s]==v.Normal){let n=e.neighbouring_bombs_count[s];n>0&&(t.fillStyle="#000",t.font=20*this.gui_scale+"px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(n.toString(),r+o/2,a+c/2+2*this.gui_scale,o))}else e.cell_type[s]==v.Bomb&&(t.fillStyle="red",t.font=20*this.gui_scale+"px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("!",r+o/2,a+c/2+2*this.gui_scale,o));else{t.fillStyle="#979797",t.fillRect(r,a,o,c);const n=this.gui_scale;t.fillStyle="#eeeeee",t.fillRect(r+n,a+n,o-2*n,c-2*n),e.cell_state[s]&C.Flagged&&(t.fillStyle="red",t.font=20*this.gui_scale+"px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("F",r+o/2,a+c/2+2*this.gui_scale,o))}}}drawPlayer(e){let t=this.draw_context,[n,i]=(this.client_player,e.targeted_block);if(n>=this.visible_world_rect.x1&&n<this.visible_world_rect.x2&&i>=this.visible_world_rect.y1&&i<this.visible_world_rect.y2){t.strokeStyle="#28ff49",t.lineWidth=3*this.gui_scale;let e=this.worldToScreen(n,i);t.strokeRect(...e,this.scale,this.scale)}}handleMouseDown(e){e.preventDefault(),document.pointerLockElement!==this.canvas?this.canvas.requestPointerLock():0==e.button||1==e.button?this.actionBeginClick():2==e.button&&this.actionFlag(...this.client_player.targeted_block)}handleMouseMove(e){e.preventDefault(),document.pointerLockElement===this.canvas&&this.actionMove(e.movementX,e.movementY)}handleMouseUp(e){e.preventDefault();let t=this.client_player.targeted_block;this.clicking_block&&(this.clicking_block[0]===t[0]&&this.clicking_block[1]===t[1]&&this.actionClick(...this.clicking_block),this.clicking_block=null)}handleTouchStart(e){e.preventDefault(),document.addEventListener("touchmove",this.handleTouchMove),document.addEventListener("touchend",this.handleTouchEnd)}handleTouchMove(e){e.preventDefault()}handleTouchEnd(e){e.preventDefault(),document.removeEventListener("touchmove",this.handleTouchMove),document.removeEventListener("touchend",this.handleTouchEnd)}handleWheel(e){let t=.2*-Math.sign(e.deltaY);this.scale*=1+t,this.scale<20&&(this.scale=20),this.scale>window.innerWidth/10&&(this.scale=window.innerWidth/10),this.gui_scale=this.scale/32}actionMove(e,t){e=Math.sign(e)*Math.max(Math.pow(Math.abs(e),1.1),e),t=Math.sign(t)*Math.max(Math.pow(Math.abs(t),1.1),t),this.cursor_at_world[0]+=e/this.scale,this.cursor_at_world[1]+=t/this.scale}isClickable(e,t){return!(e.cell_state[t]&C.Clicked||e.cell_state[t]&C.Flagged||e.cell_type[t]==v.Open)}isFlaggable(e,t){return e.cell_state[t]&C.Flagged||this.isClickable(e,t)}computeAutoClickTargets(e,t){let n=this.chunk_manager.getChunkOfBlock(e,t);if(!n)return[];let[i,l]=n;if(!(i.cell_state[l]&C.Clicked)||i.cell_type[l]!=v.Normal)return[];let s=i.neighbouring_bombs_count[l],r=[],a=0;for(let s=-1;s<=1;s+=1)for(let o=-1;o<=1;o+=1)if(0!=s||0!=o){if(n=this.chunk_manager.getChunkOfBlock(e+o,t+s),!n)return[];[i,l]=n,i.cell_state[l]&C.Flagged||i.cell_state[l]&C.Clicked&&i.cell_type[l]==v.Bomb?a+=1:i.cell_state[l]&C.Clicked||i.cell_type[l]==v.Open||r.push([e+o,t+s])}return a==s?r:[]}actionBeginClick(){let e=this.client_player.targeted_block.slice(),t=this.chunk_manager.getChunkOfBlock(...e);if(!t)return;let[n,i]=t;(this.isClickable(n,i)||this.computeAutoClickTargets(...e).length>0)&&(this.clicking_block=e)}actionClick(e,t){let n=this.chunk_manager.getChunkOfBlock(e,t);if(!n)return!1;let[i,l]=n;if(i.cell_state[l]&C.Flagged)return!1;if(this.isClickable(i,l))return this.clicking_block=null,i.cell_state[l]|=C.Clicked,this.animateOpenNearbyCells(e,t),!0;let s=this.computeAutoClickTargets(e,t);if(s.length>0){for(let[e,t]of s)this.actionClick(e,t);return!0}return!1}actionFlag(e,t){let n=this.chunk_manager.getChunkOfBlock(e,t);if(!n)return;let[i,l]=n;this.isFlaggable(i,l)&&(i.cell_state[l]^=C.Flagged)}iterOpenNearbyCells(){let e=[];for(let t of this.open_nearby_cells_queue)e.push(...this._tryOpenNearbyCellsSingle(...t));this.open_nearby_cells_queue=e}animateOpenNearbyCells(e,t){this.open_nearby_cells_queue.push([e,t])}_tryOpenNearbyCellsSingle(e,t){let n=this.chunk_manager.getChunkOfBlock(e,t);if(!n)return[];let[i,l]=n,s=[],r=!1;if((i.cell_state[l]&C.Clicked||i.cell_type[l]===v.Open)&&0===i.neighbouring_bombs_count[l])for(let a=-1;a<=1;a+=1)for(let o=-1;o<=1;o+=1){if(0==o&&0==a)continue;let c=e+o,h=t+a;n=this.chunk_manager.getChunkOfBlock(c,h),n&&([i,l]=n,i.cell_type[l]!=v.Normal||i.cell_state[l]&(C.Flagged|C.Clicked)||(i.cell_state[l]|=C.Clicked,r=!0),s.push([c,h]))}return r?s:[]}constructor(e,t=null){this.canvas=e,this.generator=new p(0),this.chunk_manager=new O(this.generator),this.client_player=new E,this.center_pos=this.client_player.targeted_block.map((e=>e+.5)),this.scale=this.getDefaultScale(),this.last_update_time=Date.now(),this.on_init_complete=t,this.draw_context=e.getContext("2d"),this.gui_scale=this.scale/32,this.players=[this.client_player],this.cursor_at_world=[.5,.5],this.mouse_sensitivity_inv=1.8*this.scale,this.clicking_block=null,this.open_nearby_cells_queue=[],this.last_nearby_cell_auto_open_time=Date.now(),this.update=this.update.bind(this),this.update(),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleWheel=this.handleWheel.bind(this),e.addEventListener("mousedown",this.handleMouseDown),e.addEventListener("mousemove",this.handleMouseMove),e.addEventListener("mouseup",this.handleMouseUp),e.addEventListener("contextmenu",(e=>e.preventDefault())),e.addEventListener("touchstart",this.handleTouchStart),e.addEventListener("wheel",this.handleWheel),e.addEventListener("pointerlockerror",(e=>{alert("Pointer lock is not supported on your browser. Please use an alternative browser to play this game.")})),this.animateOpenNearbyCells(...this.client_player.targeted_block)}}}();
//# sourceMappingURL=index.45b44beb.js.map
